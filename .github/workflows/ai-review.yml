name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para comparar branches

      - name: Get PR Diff
        id: diff
        run: |
          # Captura as mudanÃ§as entre a branch atual e a base do PR
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

      - name: Run Gemini CLI
        id: gemini
        uses: google-github-actions/run-gemini-cli@main
        with:
          gemini_api_key: ${{ secrets.AI_API_KEY }}
          # O segredo aqui Ã© passar o arquivo pr_diff.txt no prompt
          prompt: |
            Aja como um Engenheiro de SeguranÃ§a SÃªnior (DevSecOps). 
            Analise as mudanÃ§as abaixo buscando:
            1. Vulnerabilidades OWASP Top 10 (SQL Injection, etc)
            2. Code Smells e complexidade ciclomÃ¡tica
            3. Java 25 e Spring Boot 3.4 best practices
            
            Diferencial: Responda em PortuguÃªs e seja direto.
            
            --- MUDANÃ‡AS NO CÃ“DIGO ---
            $(cat pr_diff.txt)
          gemini_model: gemini-2.0-flash

      - name: Post Review on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // A saÃ­da da action anterior fica disponÃ­vel no step. outputs.text ou similar
            // dependendo da versÃ£o, mas a forma mais segura Ã© capturar o log ou via output definido
            const response = process.env.GEMINI_OUTPUT; 
            
            if (response) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸ¤– AI Code Review (Gemini 2.0 Flash)\n\n${response}`
              });
            }
        env:
          GEMINI_OUTPUT: ${{ steps.gemini.outputs.text }}